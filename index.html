<!--
    
{} 
|| 
||   .,,;;;;;;,,.. 
||.;;;;;;*;;;;;;;*;;, ..,,;;;;;;%%%%%, 
||';*;;;;;;;;*;;;;;;,::*::;;;*;;%%%%%%>>%%%%%,                 .; 
|| ';;;;;*;;;;;;;;*;;,:::::*;;;;;@@@##>>%%%%%%,        ..,,;%%%%' 
||  ;*;;;;;;;;*;;;;;;,::*;:;;;;*;@@@@##ooO0@@##>>%%%%%%%%%%%%%%' 
||  ;;;;;;*;;;;;;;;*;;,:;:::*;;;;%%%%%%ooO0@@##>>%%%%%%%%%%a@@' 
||  ;;*;;;;;;;;;*;;;;;,::*;::;;;*;%%%%%%>>%%%%%%ooO@@@@@@@@@@@ 
||  ;;;;;;*;;;;;;;;*;;,:::::;*;;;;@@@@##>>%%%%%%%ooO@@@@@@@@%% 
||  ;;*;;;;;;;;;*;;;;;;,::*;:;;;*;@@@@@##ooO0@@##>>%%%%%%%%%%% 
||  ;;;;;;;*;;;;;;;*;;;,:::::*;;;;;%%%%%%ooO0@@@##>>%%%%%%%%a@, 
||  ;;;*;;;;;;;;*;;;;;;,::*:;;;;;*;%%%%%%%>>%%%%%%%%ooO@@@@@@@@ 
||  ;;;;;;;*;;;;;;;;*;;;,::::;*;;;;@@@@@##>>%%%%%%%%%ooO@@@@@%%' 
||  ;;*;;;;;;;;*;;;;;;;;,::*:;;;:;*;@@@@@##ooO0@@@@##>>%%%%%%%% 
||  ;;;;;;;*;;;;;;*;;;;*;,::::;*;;;;;%%%%%%ooO00@@@@##>>%%%%%a@ 
||  ;*;;a@@@#######@@@@@a,:::*;;;;;;*;%%%%%%>>%%%%%%%%%ooO@@@@@, 
||  ;;@@@@@@#######@@@@@##ooO00@@@@@@@@@@@##>>%%%%%%%%%%ooO@@@%% 
||  a@@@%%%%%%%%%%%%%%%%%%ooO00@@@@@@@@@@@@##ooO0@@@@##>>%%%%%%% 
||  @@%%%%%%%%%%%%%%%%%%%%%>>%%%%%%%%%%%%%%%%ooO00@@@@##>>%%%a@@ 
||  %%%%a@@##########@@@@##>>%%%%%%%%%%%%%%%%%>>%%%%%%%%%ooO@@@a 
||  %%@@@@@##########@@@@@##ooO0@@@@@@@@@@@@##>>%%%%%%%%%%ooO@%% 
||  a@@@%%%%%%%%%%%%%%%%%%%%ooO0@@@@@@@@@@@@@##ooO0@@@@##>>%%%%%. 
||  @@%%%%%%%%%%%%%%%%%%%%%%%>>%%%%%%%%%%%%%%%%ooO0@@@@@##>>%%%a@ 
||  %%%%a@@############@@@@##>>%%%%%%%%%%%%%%%%%>>%%%%%%%%%%ooO@@a 
||  %%@@@@@############@@@@@##ooO0@@@@@@@@@@@@##>>%%%%%%%%%%%ooO%% 
||  a@@@%%%%%%%%%%%%%%%%%%%%%%ooO0@@@@@@@@@@@@@##ooO0@@@@##%>>%%%% 
||  @@%%%%%%%%%%%%%%%%%%%%%%%%%>>%%%%%%%%%%%%%%%%ooO0@@@@@##>>%%a@ 
|| .%%%'                        `>%%%%%%%%%%%%%%%%>>%%%%%%%%%ooO@@, 
||.%%                                             `>%%%%%%%%%ooO%%% 
||'                                                          `%%%%% 
||                                                            `%%' 
|| 
|| 
|| 
||   MADE WITH <3 IN THE CITY OF LOVE
||   PHILADELPHIA, PENNSYLVANIA, USA
|| 
||   
||   
||   
|| 
|| 
|| 
--
-->

<html>

<head>
    <title>Sketchadelphia</title>

    <meta name="description" content="How sketchy is your next drive through Philly?">

    <!-- Materialize  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- ReactJS -->
    <script src="https://unpkg.com/react@16/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- Importing 3rd party libraries -->
    <script src="js/cookies.js"></script>
    <script src="js/random.js"></script>
    <script src="js/polyline.js"></script>

    <!-- JS resources -->
    <script src="js/ratingstars.js"></script>

    <!-- Custom styles -->
    <link rel="stylesheet" href="https://brendanmanning.github.io/Sketchadelphia/mainstyle.css">

    <!-- Mobile fix -->
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">

    <style>
        
        #rating-bar {
            
            position: fixed;
                        
            z-index: 2;

            height: 40px;
            width: 160px;

            bottom: 32px;
            right: 16px;

            padding: 8px;

            border-radius: 4px;

            background-color: rgb(12, 153, 184);
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);

        }

        .star-icon {
            color: white;
            font-size: 24px;
        }
    
    </style>

</head>

<body>
    
  <!-- Modal Structure -->
  <div id="feedback-modal" class="modal">
    <div class="modal-content" style="display: flex; flex-direction: row;">
        <div style="flex: 2">
            <img height="180" src="img/RedditAvatar.png"/>
        </div>
        <div style="flex: 10">
            <div>
                <center>
                    <h4>Hey Reddit</h4>
                    <p>Let me know how I'm doing!</p>
                </center>
            </div>
            <div>
                <center>
                    <a id="rating-star-1" onmouseover="hoverStar(1)" class="modal-close waves-effect waves-green btn-flat"><i class='material-icons' style="font-size: 36px;">star_border</i></a>
                    <a id="rating-star-2" onmouseover="hoverStar(2)" class="modal-close waves-effect waves-green btn-flat"><i class='material-icons' style="font-size: 36px;">star_border</i></a>
                    <a id="rating-star-3" onmouseover="hoverStar(3)" class="modal-close waves-effect waves-green btn-flat"><i class='material-icons' style="font-size: 36px;">star_border</i></a>
                    <a id="rating-star-4" onmouseover="hoverStar(4)" class="modal-close waves-effect waves-green btn-flat"><i class='material-icons' style="font-size: 36px;">star_border</i></a>
                    <a id="rating-star-5" onmouseover="hoverStar(5)" class="modal-close waves-effect waves-green btn-flat"><i class='material-icons' style="font-size: 36px;">star_border</i></a>
                </center>
            </div>
            <div class="modal-footer" style="margin-top: 16px; right: 16px; bottom: 16px;">
                <button id="rating-submit-button" onclick="submitRating()" class="btn modal-close waves-effect waves-light" disabled="disabled">Submit
                    <i class="material-icons right">send</i>
                </button>
            </div>
        </div>
    </div>
  </div>

    

    <!-- FAB -->
    <div class="fixed-action-btn">
        <a class="btn-floating btn-large blue sidenav-trigger" href="http://sketchadelphia.com">
            <i class="large material-icons">search</i>
        </a>
    </div>

    <!-- Side Nav -->
    <ul id="slide-out" class="sidenav">

        <nav>
            <div class="nav-wrapper" style="background-color: #3D87B4; height: 64px;">
                <a href="#" class="brand-logo" style="font-size: 21px; margin-left: 8px;">Sketchadelphia</a>
            </div>
        </nav>


        <div class="row" style="background-color: #469BCF; height: calc(100% - 14px); overflow: hidden">
            <div class="col s12">
                <div class="nav-content" style="color: white; font-weight: bold;">
                    <p>How sketchy is your next drive through Philly??</p>
                    <p>(Enter any address in the city)</p>
                </div>
            </div>
            <div class="col s12">
                <div class="input-field col s12">
                    <i class="material-icons prefix">bubble_chart</i>
                    <input type="text" id="fromInput" oninput="inputUpdated()" class="autocomplete" placeholder="Start">
                </div>
                <div class="input-field col s12">
                    <i class="material-icons prefix">place</i>
                    <input type="text" id="toInput" oninput="inputUpdated()" class="autocomplete" placeholder="Destination">
                </div>
            </div>
            <div class="col s12">
                <div class="input-field col s12">
                    <button id="directionsButton" onclick="routePressed()" class="btn waves-effect waves-light" type="submit"
                        name="action" disabled>Go
                        <i class="material-icons right">directions</i>
                    </button>
                </div>
            </div>
        </div>

    </ul>

    <!-- Statistics Side Bar -->
    <ul id="statistics" class="collapsible" style="display: none;">
        <li>
            <div id="sketchFactorStatHeader" class="collapsible-header">
                <center>
                    <i style="font-size: 32px; text-align: center; vertical-align: center" class="material-icons" id="sentiment">sentiment_neutral</i>
                    <br>
                    <span id="sketchFactorStat">123%</span>
                    <br>
                    <span id="sketchFactorExplanationStat">crimes reported along this route.</span>
                </center>
            </div>
        </li>
        <li>
            <div class="collapsible-header"><i class="material-icons">settings</i>Tweaks</div>
            <div class="collapsible-body">
                <p>
                    <label>
                        <input id="showUnderlyingGrids" type="checkbox" onchange="gridToggled()" checked="checked" />
                        <span>Showing underlying grids</span>
                    </label>
                </p>
                <p>
                    <label>
                        <input id="showIndividualIncidents" type="checkbox" onchange="incidentsToggled()" />
                        <span>Show individual incidents</span>
                    </label>
                </p>
            </div>
        </li>
        <li>
            <div class="collapsible-header"><i class="material-icons">info_outline</i>About</div>
            <div class="collapsible-body">
                <div style="overflow: auto; display: block">
                    <p>Hi! I'm <a href="https://github.com/brendanmanning">Brendan Manning</a>, a Computer Science &
                        Physics major at Temple University.</p>
                    <p>I created Sketchadelphia after a sketchy Uber ride through North Philadelphia. This interactive
                        demonstration is meant to show that companies like Uber and Lyft should factor rider safety
                        into their algorithms.</p>
                    <p>If you are from a tech company looking to incorportate Sketchadelphia features into your app,
                        please <a href="mailto:tuj97064@temple.edu">send me an email</a></p>
                    <p>If you are a recruiter, lets <a href="https://www.linkedin.com/in/brendan-m-544823a2/">Connect
                            on Linkedin!</a></p>
                </div>
            </div>
        </li>
    </ul>

    <!-- Map View -->
    <div id="map"></div>

</body>
<script>

    var target = getUrlVars()['target'];
    var campaign = getUrlVars()['campaign'];
    
    var developerMode = false;

    var json = {};

    var polylines = [];
    var polygons = [];
    var markers = [];

    activeGrid = -1;

    function initMap() {
        
        var myLatLng = {
            lat: 39.9816,
            lng: -75.1494
        };
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: myLatLng,
            disableDefaultUI: true,
            styles: [
                {
                    "featureType": "administrative",
                    "elementType": "labels.text.fill",
                    "stylers": [
                        {
                            "color": "#444444"
                        }
                    ]
                },
                {
                    "featureType": "administrative.country",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "visibility": "off"
                        },
                        {
                            "color": "#fc6e6e"
                        }
                    ]
                },
                {
                    "featureType": "administrative.province",
                    "elementType": "geometry.fill",
                    "stylers": [
                        {
                            "visibility": "off"
                        },
                        {
                            "hue": "#008aff"
                        }
                    ]
                },
                {
                    "featureType": "landscape",
                    "elementType": "all",
                    "stylers": [
                        {
                            "color": "#f2f2f2"
                        }
                    ]
                },
                {
                    "featureType": "poi",
                    "elementType": "all",
                    "stylers": [
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {
                    "featureType": "road",
                    "elementType": "all",
                    "stylers": [
                        {
                            "saturation": -100
                        },
                        {
                            "lightness": 45
                        }
                    ]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "all",
                    "stylers": [
                        {
                            "visibility": "simplified"
                        }
                    ]
                },
                {
                    "featureType": "road.arterial",
                    "elementType": "labels.icon",
                    "stylers": [
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {
                    "featureType": "transit",
                    "elementType": "all",
                    "stylers": [
                        {
                            "visibility": "off"
                        }
                    ]
                },
                {
                    "featureType": "water",
                    "elementType": "all",
                    "stylers": [
                        {
                            "color": "#bee0ee"
                        },
                        {
                            "visibility": "on"
                        }
                    ]
                }
            ]
        });


        var autocompleteFrom = new google.maps.places.Autocomplete(document.getElementById("fromInput"));
        var autocompleteTo = new google.maps.places.Autocomplete(document.getElementById("toInput"));

        autocompleteFrom.bindTo('bounds', map);
        autocompleteTo.bindTo('bounds', map);

        autocompleteFrom.setFields(['address_components', 'icon', 'name']);
        autocompleteTo.setFields(['address_components', 'icon', 'name']);


    }

    function inputUpdated() {
        var from = document.getElementById("fromInput").value;
        var to = document.getElementById("toInput").value;
        var directionsButton = document.getElementById("directionsButton");
        directionsButton.disabled = from.length == 0 || to.length == 0;
    }

    function routePressed() {

        // First clear everything we already did
        reset();

        // Now get the to and from
        var from = document.getElementById("fromInput").value;
        var to = document.getElementById("toInput").value;

        // Now map it
        fetch('http://api.sketchadelphia.com/directions?from=' + encodeURIComponent(from) + "&to=" + encodeURIComponent(to), {
            mode: 'cors',
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                'Access-Control-Allow-Origin': '*'
            }
        }).then(function (response) {
            return response.json();
        }).then(function (myjson) {
            json = myjson;

            if (json['success']) {
                
                presentRoute();
                logRoute(from, to);
                
            } else {
                M.toast({ html: json['message'] })
            }
        }).catch(function () {
            M.toast({ html: 'An unknown error occured.' });
            M.toast({ html: 'Are you sure you have internet connection?' });
        });
    }

    function logRoute(from, to) {
        fetch('https://jddk75lrxk.execute-api.us-east-1.amazonaws.com/default/sketchadelphiaRouteRequested?from=' + encodeURIComponent(from) + "&to=" + encodeURIComponent(to) + "&campaign=" + encodeURIComponent(campaign) + "&target=" + encodeURIComponent(target), {
            method: "POST",
            mode: "no-cors"
        }).then(function (response) {
            return response.json();
        }).then(function (json) {
            alert(JSON.stringify(json));
        }).catch(function () {
            console.error("Error logging route to AWS");
        });
    }

    function gridToggled() {
        if (document.getElementById("showUnderlyingGrids").checked) {
            plotGrids();
        } else {
            clearPolygons();
        }
    }

    function incidentsToggled() {
        if (document.getElementById("showIndividualIncidents").checked) {
            for (var g = 0; g < json['grids'].length; g++) {
                showIncidents(g);
            }
        } else {
            clearMarkers();
        }
    }

    function presentRoute() {
        plotDirections(json['googleResponse']);
        showRouteStatistics(json);
        gridToggled();
        
        // Ask them for feedback in 10 seconds
        setTimeout(function() {
            if(getUrlVar("campaign") == "dataisbeautiful" && !isMobile()) {
                var instance = M.Modal.getInstance(document.getElementById('feedback-modal'));
                instance.open();
            }
        }, 10000);
    }

    function showRouteStatistics() {
        document.getElementById("statistics").style.display = "block";
        document.getElementById("sketchFactorStat").innerHTML = numberFormat(json['reportedIncidents']);
        document.getElementById("sketchFactorExplanationStat").innerHTML = "crimes reported along this route in 2018.";
        document.getElementById("sentiment").innerHTML = getEmoticon();
    }

    function showGridStatistics() {
        document.getElementById("statistics").style.display = "block";
        document.getElementById("sketchFactorStat").innerHTML = numberFormat(json['grids'][activeGrid]['incidents'].length);
        document.getElementById("sketchFactorExplanationStat").innerHTML = "crimes reported in this segment of your trip in 2018.";
    }
    
    function plotDirections() {
        var route = json['googleResponse']['routes'][0];
        var legs = route['legs'];
        for (var l = 0; l < legs.length; l++) {
            var steps = legs[l]['steps'];
            for (var s = 0; s < steps.length; s++) {
                //var color = getColor(grids[whichGrid(steps[s]['polyline']['points'][0])]['incidents'].length, json['averageIncidentsPerGrid']);
                //console.log(color);
                var path = decodePolylineString(steps[s]['polyline']['points']);
                var polyline = new google.maps.Polyline({
                    path: path,
                    geodesic: true,
                    strokeOpacity: 1.0,
                    strokeWeight: 3,
                    strokeColor: '#3D87B4'
                });
                polylines.push(polyline);
                polyline.setMap(map);
            }
        }
    }

    function whichGrid(coordinates) {
        for (var g = 0; g < grids.length; g++) {

            var topLeftX = grids[g]['topLeft'][0];
            var topLeftY = grids[g]['topLeft'][1];
            var bottomRightX = grids[g]['topLeft'][0] + json['blockWidth'];
            var bottomRightY = grids[g]['topLeft'][1] - json['blockHeight'];

            if (coordinates[0] >= topLeftX && coordinates[0] < bottomRightX) {
                if (coordinates[1] <= topLeftY && coordinates[1] > bottomRightY) {
                    return g;
                }
            }
        }

        return -1;
    }

    function getColor(i, a) {

        var red = {
            r: 255,
            g: 0,
            b: 0
        };
        var yellow = {
            r: 255,
            g: 242,
            b: 0
        };
        var green = {
            r: 30,
            g: 150,
            b: 0
        };

        if (i == a) {
            return "yellow";
        }

        if (i > a) {
            return "red";
        }

        if (i < a) {
            return "green";
        }
    }

    function rgbToHex(o) {

        var r = o.r;
        var g = o.g;
        var b = o.b;

        var bin = r << 16 | g << 8 | b;
        return "#" + (function (h) {
            return new Array(7 - h.length).join("0") + h
        })(bin.toString(16).toUpperCase())
    }

    function plotGrids() {

        var blockWidth = json['blockWidth'];
        var blockHeight = json['blockHeight'];
        for (var g = 0; g < json['grids'].length; g++) {
            var grid = json['grids'][g];
            var topLeft = [
                grid['topLeft']['lat'],
                grid['topLeft']['lon']
            ];
            var coords = [
                new google.maps.LatLng(topLeft[0], topLeft[1]),
                new google.maps.LatLng(topLeft[0], topLeft[1] + blockWidth),
                new google.maps.LatLng(topLeft[0] - blockHeight, topLeft[1] + blockWidth),
                new google.maps.LatLng(topLeft[0] - blockHeight, topLeft[1])
            ];
            var color = getColorForPercentile(getPercentileIndex(grid['incidents'].length, json['percentiles']));
            var polygon = new google.maps.Polygon({
                paths: coords,
                strokeColor: color,
                strokeOpacity: 1,
                strokeWeight: 1,
                fillColor: color,
                fillOpacity: 0.35,
                index: g
            });
            google.maps.event.addListener(polygon, 'click', function (event) {
                M.toast({html: '<strong>' + json['grids'][this.index]['incidents'].length + ' </strong>crimes in this grid.'})

            });


            // https://icons8.com/icon/17907/gun
            // https://icons8.com/icon/52810/pill
            // https://img.icons8.com/ultraviolet/2x/car-theft.png
            // https://icons8.com/icon/51106/spray


            polygons.push(polygon);
            polygon.setMap(map);
        }

    }

    function getPercentileIndex(a, percentiles) {
        for (var p = 0; p < percentiles.length; p++) {
            if (a <= percentiles[p]['upperBound']) {
                return p;
            }
        }
        return percentiles.length - 1;
    }

    /// 0 12 345 67 8
    function getEmoticon() {
        var index = getPercentileIndex(json['reportedIncidents']/json['grids'].length,json['percentiles']);
        switch(index) {
            case 8: return "sentiment_very_dissatisfied";
            case 7: return "sentiment_dissatisfied";
            case 6: return "sentiment_dissatisfied";
            case 5: return "sentiment_neutral";
            case 4: return "sentiment_neutral";
            case 3: return "sentiment_neutral";
            case 2: return "sentiment_satisfied";
            case 1: return "sentiment_satisfied";
            case 0: return "sentiment_very_satisfied";
            default: return null;
        }
    }

    function getColorForPercentile(percentileIndex) {
        var colors = ['#66ff66', '#66ff66', '#8cff66', '#b3ff66', '#d9ff66', '#ffff66', '#ffd966', '#ffb366', '#ff8c66', '#ff6666'];
        return colors[percentileIndex];
    }

    function getAveragePercentileForRoute() {
        return json['percentiles'][getPercentileIndex(json['reportedIncidents']/json['grids'].length, json['percentiles'])]['percentile'];
    }

    function toggleIncidents(gridIndex) {

        // If nothing was selected before
        if (activeGrid == -1) {

            setHighlightedGrid(gridIndex);

            activeGrid = gridIndex;
            showGridStatistics();

            map.setCenter({
                lat: json['grids'][gridIndex]['topLeft']['lat'] - (0.5 * json['blockHeight']),
                lng: json['grids'][gridIndex]['topLeft']['lon'] + (0.5 * json['blockWidth'])
            });
            map.setZoom(17);

            return;
        }

        // If we clicked on the currently active grid...
        // Remove the markers and stuff and zoom out
        if (activeGrid == gridIndex) {

            setUnhighlightedGrid(gridIndex);

            activeGrid = -1;
            showRouteStatistics();

            map.setZoom(12);

            return;
        }

        // If we clicked on a different grid
        // Change our view to that grid
        setUnhighlightedGrid(activeGrid);
        activeGrid = -1;
        toggleIncidents(gridIndex);

    }

    function getCategoriesForIncident(incidentDescription) {

        incidentDescription = incidentDescription.toUpperCase().replace(/ /g,'');

        var categories = [];

        // Basic Categories
        var murder = ["HOMICIDE-CRIMINAL", "HOMICIDE-JUSTIFIABLE", "HOMICIDE-GROSS NEGLIGENCE"];
        var theft = ["THEFTS", "THEFTFROMVEHICLE", "RECOVEREDSTOLENMOTORVEHICLE", "BURGLARYRESIDENTIAL", "ROBBERYNOFIREARM", "MOTORVEHICLETHEFT", "ROBBERYFIREARM", "BURGLARYNON-RESIDENTIAL", "RECEIVINGSTOLENPROPERTY" ];
        var money = ["FRAUD", "FORGERYANDCOUNTERFEITING" ];
        var vice = ["DRIVINGUNDERTHEINFLUENCE", "OTHERSEXOFFENSES(NOTCOMMERCIALIZED)", "PROSTITUTIONANDCOMMERCIALIZEDVICE", "RAPE", "LIQUORLAWVIOLATIONS", "PUBLICDRUNKENNESS", "GAMBLINGVIOLATIONS" ];
        var drug = [ "NARCOTIC/DRUGLAWVIOLATIONS" ];
        var domestic = [ "OFFENSESAGAINSTFAMILYANDCHILDREN" ];

        if(murder.includes(incidentDescription)) {
            categories.push("Murder");
        } else if(theft.includes(incidentDescription)) {
            categories.push("Theft");
        } else if(money.includes(incidentDescription)) {
            categories.push("Money-Related");
        } else if(vice.includes(incidentDescription)) {
            categories.push("Vice (Alcohol, Gambling, Sex)");
        } else if(drug.includes(incidentDescription)) {
            categories.push("Narcotics");
        } else if(murder.includes(incidentDescription)) {
            categories.push("Domestic/Family");
        }

        return categories;
        
    }

    function getIconForIncident(incidentDescription) {

        incidentDescription = incidentDescription.toUpperCase().replace(/ /g,'');

        var map = {
            "ALLOTHEROFFENSES": "ASTERISK",
            "OTHERASSAULTS": "ASTERISK",
            "THEFTS": "CROWBAR",
            "VANDALISM/CRIMINALMISCHIEF": "SPRAYPAINT",
            "THEFTFROMVEHICLE": "CARTHEFT",
            "NARCOTIC/DRUGLAWVIOLATIONS": "PILL",
            "FRAUD": "MONEY",
            "RECOVEREDSTOLENMOTORVEHICLE": "CARTHEFT",
            "BURGLARYRESIDENTIAL": "CROWBAR",
            "AGGRAVATEDASSAULTNOFIREARM": "SKIMASK",
            "DRIVINGUNDERTHEINFLUENCE": "BOOZE",
            "ROBBERYNOFIREARM": "CROWBAR",
            "MOTORVEHICLETHEFT": "CARTHEFT",
            "ROBBERYFIREARM": "GUN",
            "DISORDERLYCONDUCT": "ASTERISK",
            "AGGRAVATEDASSAULTFIREARM": "SKIMASK",
            "BURGLARYNON-RESIDENTIAL": "SKIMASK",
            "WEAPONVIOLATIONS": "GUN",
            "OTHERSEXOFFENSES(NOTCOMMERCIALIZED)": "XXX",
            "PROSTITUTIONANDCOMMERCIALIZEDVICE": "XXX",
            "RAPE": "XXX",
            "VAGRANCY/LOITERING": "ASTERISK",
            "ARSON": "FIRE",
            "LIQUORLAWVIOLATIONS": "BOOZE",
            "EMBEZZLEMENT": "MONEY",
            "FORGERYANDCOUNTERFEITING": "MONEY",
            "PUBLICDRUNKENNESS": "BOOZE",
            "OFFENSESAGAINSTFAMILYANDCHILDREN": "FAMILY",
            "": "ASTERISK",
            "GAMBLINGVIOLATIONS": "DICE",
            "RECEIVINGSTOLENPROPERTY": "CROWBAR",
            "HOMICIDE-CRIMINAL": "SKULL",
            "HOMICIDE-JUSTIFIABLE": "SKULL",
            "HOMICIDE-GROSS NEGLIGENCE": "SKULL"
        }

        return "img/" + map[incidentDescription] + ".png";

    }

    function setHighlightedGrid(gridIndex) {
        polygons[gridIndex].setOptions({
            fillColor: 'yellow',
            fillOpacity: 0.6
        })
    }

    function setUnhighlightedGrid(gridIndex) {
        polygons[gridIndex].setOptions({
            fillColor: 'black',
            fillOpacity: 0.35
        })
    }

    function showIncidents(gridIndex) {
        var incidents = json['grids'][gridIndex]['incidents'];
        for (var i = 0; i < incidents.length; i++) {
            var incident = incidents[i];
            var icon = getIconForIncident(incident['description']);
            var marker = new google.maps.Marker({
                position: {
                    lat: incident['coordinates']['lat'],
                    lng: incident['coordinates']['lon']
                },
                map: map,
                icon: {
                    url: "img/MARKER.png",
                    scaledSize: new google.maps.Size(20, 20)
                }
            });
            markers.push(marker);
            marker.addListener('click', function () {
                M.toast({ html: incident['description'].toUpperCase() })
            });
        }
    }

    function decodePolylineString(str) {
        var polygonsAsTwoDArray = polyline.decode(str);
        var polygonsAsArrayOfObjects = [];
        for (var i = 0; i < polygonsAsTwoDArray.length; i++) {
            polygonsAsArrayOfObjects.push({
                lat: polygonsAsTwoDArray[i][0],
                lng: polygonsAsTwoDArray[i][1]
            });
        }
        console.log(JSON.stringify(polygonsAsArrayOfObjects));
        return polygonsAsArrayOfObjects;
    }

    function reset() {
        clearPolylines();
        clearPolygons();
        clearMarkers();

        json = {};
        activeGrid = -1;
    }
    
    function clearPolylines() {
        for (var p = 0; p < polylines.length; p++) {
            polylines[p].setMap(null);
        }
        polylines.length = 0;
    }

    function clearPolygons() {
        for (var p = 0; p < polygons.length; p++) {
            polygons[p].setMap(null);
        }
        polygons.length = 0;
    }

    function clearMarkers() {
        for (var m = 0; m < markers.length; m++) {
            markers[m].setMap(null);
        }
        markers = [];
    }

    const numberFormat = (x) => {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function isMobile() {
        return (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
    }
    
    function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
            vars[key] = value;
        });
        return vars;
    }

    function getUrlVar(v) {
        return getUrlVars()[v];
    }

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyB7J1zsErb9_7jxNu5KU5kIENFObAQEbl0&callback=initMap&libraries=places">
</script>
<script>

    function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
            vars[key] = value;
        });
        return vars;
    }

    document.addEventListener('DOMContentLoaded', function () {
        if (getUrlVars()['demo'] != undefined) {
            document.getElementById("fromInput").value = "Philadelphia International Airport";
            document.getElementById("toInput").value = "Sugarhouse Casino";
            document.getElementById("directionsButton").disabled = false;
        }
        if (isMobile()) {
            document.getElementById("statistics").style += " width: 150px; position: absolute; left: calc(50% - 150px)";
        } else {
            document.getElementById("statistics").style += " margin-right: 16px;";
        }
        document.getElementById("statistics").style.display = 'none';
    });

    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.sidenav');
        var instances = M.Sidenav.init(elems, undefined);

        for (var e = 0; e < elems.length; e++) {
            var instance = M.Sidenav.getInstance(elems[e]);
            instance.open();
        }

    });
    
    document.getElementById("directionsButton").addEventListener("click", function () {
        var elems = document.querySelectorAll('.sidenav');
        var instances = M.Sidenav.init(elems, undefined);

        for (var e = 0; e < elems.length; e++) {
            var instance = M.Sidenav.getInstance(elems[e]);
            instance.close();
        }
    });
    
    document.addEventListener('DOMContentLoaded', function () {
            var elems = document.querySelectorAll('.fixed-action-btn');
            var instances = M.FloatingActionButton.init(elems, undefined);
    });
    
    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.collapsible');
        var instances = M.Collapsible.init(elems, undefined);
    });
    
    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.modal');
        var instances = M.Modal.init(elems, undefined);
        for (var e = 0; e < elems.legth; e++) {
            var instance = M.Modal.getInstance(elems[e]);
            instance.open();
        }
    });
  
</script>
</html>
