<!--
    
{} 
|| 
||   .,,;;;;;;,,.. 
||.;;;;;;*;;;;;;;*;;, ..,,;;;;;;%%%%%, 
||';*;;;;;;;;*;;;;;;,::*::;;;*;;%%%%%%>>%%%%%,                 .; 
|| ';;;;;*;;;;;;;;*;;,:::::*;;;;;@@@##>>%%%%%%,        ..,,;%%%%' 
||  ;*;;;;;;;;*;;;;;;,::*;:;;;;*;@@@@##ooO0@@##>>%%%%%%%%%%%%%%' 
||  ;;;;;;*;;;;;;;;*;;,:;:::*;;;;%%%%%%ooO0@@##>>%%%%%%%%%%a@@' 
||  ;;*;;;;;;;;;*;;;;;,::*;::;;;*;%%%%%%>>%%%%%%ooO@@@@@@@@@@@ 
||  ;;;;;;*;;;;;;;;*;;,:::::;*;;;;@@@@##>>%%%%%%%ooO@@@@@@@@%% 
||  ;;*;;;;;;;;;*;;;;;;,::*;:;;;*;@@@@@##ooO0@@##>>%%%%%%%%%%% 
||  ;;;;;;;*;;;;;;;*;;;,:::::*;;;;;%%%%%%ooO0@@@##>>%%%%%%%%a@, 
||  ;;;*;;;;;;;;*;;;;;;,::*:;;;;;*;%%%%%%%>>%%%%%%%%ooO@@@@@@@@ 
||  ;;;;;;;*;;;;;;;;*;;;,::::;*;;;;@@@@@##>>%%%%%%%%%ooO@@@@@%%' 
||  ;;*;;;;;;;;*;;;;;;;;,::*:;;;:;*;@@@@@##ooO0@@@@##>>%%%%%%%% 
||  ;;;;;;;*;;;;;;*;;;;*;,::::;*;;;;;%%%%%%ooO00@@@@##>>%%%%%a@ 
||  ;*;;a@@@#######@@@@@a,:::*;;;;;;*;%%%%%%>>%%%%%%%%%ooO@@@@@, 
||  ;;@@@@@@#######@@@@@##ooO00@@@@@@@@@@@##>>%%%%%%%%%%ooO@@@%% 
||  a@@@%%%%%%%%%%%%%%%%%%ooO00@@@@@@@@@@@@##ooO0@@@@##>>%%%%%%% 
||  @@%%%%%%%%%%%%%%%%%%%%%>>%%%%%%%%%%%%%%%%ooO00@@@@##>>%%%a@@ 
||  %%%%a@@##########@@@@##>>%%%%%%%%%%%%%%%%%>>%%%%%%%%%ooO@@@a 
||  %%@@@@@##########@@@@@##ooO0@@@@@@@@@@@@##>>%%%%%%%%%%ooO@%% 
||  a@@@%%%%%%%%%%%%%%%%%%%%ooO0@@@@@@@@@@@@@##ooO0@@@@##>>%%%%%. 
||  @@%%%%%%%%%%%%%%%%%%%%%%%>>%%%%%%%%%%%%%%%%ooO0@@@@@##>>%%%a@ 
||  %%%%a@@############@@@@##>>%%%%%%%%%%%%%%%%%>>%%%%%%%%%%ooO@@a 
||  %%@@@@@############@@@@@##ooO0@@@@@@@@@@@@##>>%%%%%%%%%%%ooO%% 
||  a@@@%%%%%%%%%%%%%%%%%%%%%%ooO0@@@@@@@@@@@@@##ooO0@@@@##%>>%%%% 
||  @@%%%%%%%%%%%%%%%%%%%%%%%%%>>%%%%%%%%%%%%%%%%ooO0@@@@@##>>%%a@ 
|| .%%%'                        `>%%%%%%%%%%%%%%%%>>%%%%%%%%%ooO@@, 
||.%%                                             `>%%%%%%%%%ooO%%% 
||'                                                          `%%%%% 
||                                                            `%%' 
|| 
|| 
|| 
||   MADE WITH <3 IN THE CITY OF LOVE:
||   PHILADELPHIA, PENNSYLVANIA, USA
|| 
||   
||   
||   
|| 
|| 
|| 
--
-->

<html>

<head>
    <title>Sketchadelphia</title>

    <!-- Materialize -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- Custom styles -->
    <link rel="stylesheet" href="https://brendanmanning.github.io/Sketchadelphia/mainstyle.css">

    <!-- Mobile fix -->
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">

    <!-- Importing 3rd party libraries -->
    <script src="lib/polyline.js"></script>

    <!-- Importing my own JS -->
    <script src="src/Config.js"></script>

    <style>
        /* label focus color */
 .input-field input:focus + label {
   color: rgb(220,220,220) !important;
 }
                       
             .material-icons.active {
  color: rgb(220,220,220) !important;
  }
 /* label underline focus color */
 .row .input-field input:focus {
   border-bottom: 1px solid rgb(220,220,220) !important;
   box-shadow: 0 1px 0 0 rgb(220,220,220) !important
 }
        </style>

</head>

<body>

    <!-- FAB -->
    <div class="fixed-action-btn">
        <a class="btn-floating btn-large red sidenav-trigger" href="#" data-target="slide-out">
            <i class="large material-icons">explore</i>
        </a>
    </div>

    <!-- Side Nav -->
    <ul id="slide-out" class="sidenav">

        <nav>
            <div class="nav-wrapper" style="background-color: #0d47a1; height: 64px;">
                <a href="#" class="brand-logo" style="font-size: 21px; margin-left: 8px;">Sketchadelphia</a>
            </div>
        </nav>


        <div class="row" style="background-color: #2196f3; height: calc(100% - 14px); overflow: hidden">
            <div class="col s12">
                <div class="nav-content" style="color: white; font-weight: bold;">
                    <p>How sketchy is your next drive through Philly??</p>
                    <p>(Enter any address in the city)</p>
                </div>
            </div>
            <div class="col s12">
                <div class="input-field col s12">
                    <i class="material-icons prefix">bubble_chart</i>
                    <input type="text" id="fromInput" oninput="inputUpdated()" class="autocomplete" placeholder="Start">
                </div>
                <div class="input-field col s12">
                    <i class="material-icons prefix">place</i>
                    <input type="text" id="toInput" oninput="inputUpdated()" class="autocomplete" placeholder="Destination">
                </div>
            </div>
            <div class="col s12">
                <div class="input-field col s12">
                    <button id="directionsButton" onclick="routePressed()" class="btn waves-effect waves-light" type="submit" name="action" disabled>Go
                        <i class="material-icons right">directions</i>
                    </button>
                </div>
            </div>
        </div>

    </ul>



    <!-- Modal Structure -->
    <div id="modal1" class="modal">
        <div class="modal-content">
            <h4>Modal Header</h4>
            <p>A bunch of text</p>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
        </div>
    </div>

    <!-- Statistics Side Bar -->
  
    <ul id="statistics" class="collapsible" style="display: none;">
        <li>
            <div id="sketchFactorStatHeader" class="collapsible-header"><center><span id="sketchFactorStat">123%</span><br><span id="sketchFactorExplanationStat">crimes reported  along this route.</span></center></div>
        </li>
        <li>
            <div class="collapsible-header"><i class="material-icons">settings</i>Tweaks</div>
            <div class="collapsible-body">
                <p>
                <label>
                    <input id="showUnderlyingGrids" type="checkbox" onchange="gridToggled()"/>
                    <span>Showing underlying grids</span>
                </label>
                </p>
                <p>
                    <label>
                        <input id="showIndividualIncidents" type="checkbox" onchange="incidentsToggled()"/>
                        <span>Show individual incidents</span>
                    </label>
                </p>
            </div>
        </li>
        <li>
            <div class="collapsible-header"><i class="material-icons">info_outline</i>About</div>
            <div class="collapsible-body"><div style="overflow: auto; display: block"><p>Hi! I'm <a href="https://github.com/brendanmanning">Brendan Manning</a>, a Computer Science & Physics major at Temple University.</p><p>I created Sketchadelphia after a sketchy Uber ride through North Philadelphia. This interactive demonstration is meant to that companies like Uber and Lyft should factor rider safety into their algorithms.</p><p>If you are from a tech company looking to incorportate Sketchadelphia features into your app, please <a href="mailto:tuj97064@temple.edu">send me an email</a></p><p>If you are a recruiter, lets <a href="https://www.linkedin.com/in/brendan-m-544823a2/">Connect on Linkedin!</a></p></div></div>
        </li>
    </ul>

    <!-- Map View -->
    <div id="map"></div>


</body>
<script>
    
    var developerMode = false;

    var json = {};
    
    var polylines = [];
    var polygons = [];
    var markers = [];
    
    
    activeGrid = -1;
    
    function initMap() {
        var myLatLng = {
            lat: 39.9816,
            lng: -75.1494
        };
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: myLatLng,
            disableDefaultUI: true,
            style: getGoogleMapsStyle(),
        });
    }
    
    function inputUpdated() {
        var from = document.getElementById("fromInput").value;
        var to = document.getElementById("toInput").value;
        var directionsButton = document.getElementById("directionsButton");
        directionsButton.disabled = from.length == 0 || to.length == 0;
    }
    function routePressed() {
        
        // First clear everything we already did
        reset();
        
        // Now get the to and from
        var from = document.getElementById("fromInput").value;
        var to = document.getElementById("toInput").value;
        
        // Now map it
        fetch('http://api.sketchadelphia.com/directions?from=' + encodeURIComponent(from) + "&to=" + encodeURIComponent(to), {
            mode: 'cors',
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                'Access-Control-Allow-Origin':'*'
            }
        }).then(function(response) {
            return response.json();
        }).then(function(myjson) {
            json = myjson;
            
            if(json['success']) {
                presentRoute();
            } else {
                M.toast({html: json['message']})
            }
        }).catch(function() {
            M.toast({html: 'An unknown error occured.'});
            M.toast({html: 'Are you sure you have internet connection?'});
        });
    }

    function gridToggled() {
        if(document.getElementById("showUnderlyingGrids").checked) {
            plotGrids();
        } else {
            clearPolygons();
        }
    }

    function incidentsToggled() {
        if(document.getElementById("showIndividualIncidents").checked) {
            for(var g = 0; g < json['grids'].length; g++) {
                showIncidents(g);
            }
        } else {
            clearMarkers();
        }
    }
    
    function presentRoute() {
        plotDirections(json['googleResponse']);
        showRouteStatistics(json);
    }
    
    function showRouteStatistics() {
        document.getElementById("statistics").style.display = "block";
        document.getElementById("sketchFactorStat").innerHTML = numberFormat(json['reportedIncidents']);
        document.getElementById("sketchFactorExplanationStat").innerHTML = "crimes reported along this route in 2018.";
    }
    
    function showGridStatistics() {
        document.getElementById("statistics").style.display = "block";
        document.getElementById("sketchFactorStat").innerHTML = numberFormat(json['grids'][activeGrid]['incidents'].length);
        document.getElementById("sketchFactorExplanationStat").innerHTML = "crimes reported in this segment of your trip (since 2017).";
    }
    function plotDirections() {
        var route = json['googleResponse']['routes'][0];
        var legs = route['legs'];
        for (var l = 0; l < legs.length; l++) {
            var steps = legs[l]['steps'];
            for (var s = 0; s < steps.length; s++) {
                var path = decodePolylineString(steps[s]['polyline']['points']);
                var polyline = new google.maps.Polyline({
                    path: path,
                    geodesic: true,
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                });
                polylines.push(polyline);
                polyline.setMap(map);
            }
        }
    }
    

    function getColor(i,a) {
        
        var red = {
            r: 255,
            g: 0,
            b: 0
        };
        var yellow = {
            r: 255,
            g: 242,
            b: 0
        };
        var green = {
            r: 30,
            g: 150,
            b: 0
        };

        if( i == a) {
            return "yellow";
        }

        if( i > a ) {
            return "red";
        } 

        if( i < a ) {
            return "rgb(30,30,200)";
        }
    }

    function rgbToHex(o){
        
        var r = o.r;
        var g = o.g;
        var b = o.b;

        var bin = r << 16 | g << 8 | b;
        return "#" + (function(h){
            return new Array(7-h.length).join("0")+h
        })(bin.toString(16).toUpperCase())
    }


    function plotGrids() {
        
        var blockWidth = json['blockWidth'];
        var blockHeight = json['blockHeight'];
        for(var g = 0; g < json['grids'].length; g++) {
            var grid = json['grids'][g];
            var topLeft = [
                grid['topLeft']['lat'],
                grid['topLeft']['lon']
            ];
            var coords = [
                new google.maps.LatLng(topLeft[0], topLeft[1]),
                new google.maps.LatLng(topLeft[0], topLeft[1] + blockWidth),
                new google.maps.LatLng(topLeft[0] - blockHeight, topLeft[1] + blockWidth),
                new google.maps.LatLng(topLeft[0] - blockHeight, topLeft[1])
            ];
            var color = getColor(grid['incidents'].length, json['averageIncidentsPerGrid']);
            var polygon = new google.maps.Polygon({
                paths: coords,
                strokeColor: color,
                strokeOpacity: 1,
                strokeWeight: 1,
                fillColor: color,
                fillOpacity: 0.35,
                index: g
            });
            google.maps.event.addListener(polygon, 'click', function (event) {
                
                toggleIncidents(this.index)
            });
            polygons.push(polygon);
            polygon.setMap(map);
        }
        
    }
    
    function toggleIncidents(gridIndex) {
        
        // If nothing was selected before
        if(activeGrid == -1) {
            
            setHighlightedGrid(gridIndex);

            activeGrid = gridIndex;
            showGridStatistics();

            map.setCenter({
                lat: json['grids'][gridIndex]['topLeft']['lat'] - (0.5 * json['blockHeight']),
                lng: json['grids'][gridIndex]['topLeft']['lon'] + (0.5 * json['blockWidth'])
            });
            map.setZoom(17);
            
            return;
        }
     
        // If we clicked on the currently active grid...
        // Remove the markers and stuff and zoom out
        if(activeGrid == gridIndex) {
            
            setUnhighlightedGrid(gridIndex);

            activeGrid = -1;
            showRouteStatistics();
            
            map.setZoom(12);
            
            return;
        }
        
        // If we clicked on a different grid
        // Change our view to that grid
        setUnhighlightedGrid(activeGrid);
        activeGrid = -1;
        toggleIncidents(gridIndex);

    }

    function setHighlightedGrid(gridIndex) {
        polygons[gridIndex].setOptions({
            fillColor: 'yellow',
            fillOpacity: 0.6
        })
    }

    function setUnhighlightedGrid(gridIndex) {
        polygons[gridIndex].setOptions({
            fillColor: 'black',
            fillOpacity: 0.35
        })
    }
    
    function showIncidents(gridIndex) {
        
        var incidents = json['grids'][gridIndex]['incidents'];
        for(var i = 0; i < incidents.length; i++) {
            var incident = incidents[i]
            var marker = new google.maps.Marker({
                position: {
                    lat: incident['coordinates']['lat'],
                    lng: incident['coordinates']['lon']
                }, 
                map: map
            });
            markers.push(marker);
            marker.addListener('click', function() {
                  M.toast({html: incident['description'].toUpperCase()})
            });
        }
    }
    
    function decodePolylineString(str) {
        var polygonsAsTwoDArray = polyline.decode(str);
        var polygonsAsArrayOfObjects = [];
        for (var i = 0; i < polygonsAsTwoDArray.length; i++) {
            polygonsAsArrayOfObjects.push({
                lat: polygonsAsTwoDArray[i][0],
                lng: polygonsAsTwoDArray[i][1]
            });
        }
        console.log(JSON.stringify(polygonsAsArrayOfObjects));
        return polygonsAsArrayOfObjects;
    }
    
    function reset() {
        clearPolylines();
        clearPolygons();
        clearMarkers();
        
        json = {};
        activeGrid = -1;
    }
    function clearPolylines() {
        for (var p = 0; p < polylines.length; p++) {
            polylines[p].setMap(null);
        }
        polylines.length = 0;
    }
    
    function clearPolygons() {
        for (var p = 0; p < polygons.length; p++) {
            polygons[p].setMap(null);
        }
        polygons.length = 0;
    }
    
    function clearMarkers() {
        for(var m = 0; m < markers.length; m++) {
            markers[m].setMap(null);
        }
        markers = [];
    }
    
    const numberFormat = (x) => {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function isMobile() {
        return( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) );
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyB7J1zsErb9_7jxNu5KU5kIENFObAQEbl0&callback=initMap">
</script>
<script>

    function getUrlVars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
    });
    return vars;
}

    document.addEventListener('DOMContentLoaded', function() {
        if(getUrlVars()['demo'] != undefined) {
            document.getElementById("fromInput").value = "Temple University";
            document.getElementById("toInput").value = "Independence Hall";
            document.getElementById("directionsButton").disabled = false;
        }
        if(isMobile()) {
            document.getElementById("statistics").style += " width: 150px; position: absolute; left: calc(50% - 150px)";
        } else {
            document.getElementById("statistics").style += " margin-right: 16px;";
        }
        document.getElementById("statistics").style.display = 'none';
    });

    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.sidenav');
        var instances = M.Sidenav.init(elems, undefined);
        
        for (var e = 0; e < elems.length; e++) {
            var instance = M.Sidenav.getInstance(elems[e]);
            instance.open();
        }
        
    });
    document.getElementById("directionsButton").addEventListener("click", function() {
        var elems = document.querySelectorAll('.sidenav');
        var instances = M.Sidenav.init(elems, undefined);
        
        for (var e = 0; e < elems.length; e++) {
            var instance = M.Sidenav.getInstance(elems[e]);
            instance.close();
        }
    });
    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.fixed-action-btn');
        var instances = M.FloatingActionButton.init(elems, undefined);
    });
    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.collapsible');
        var instances = M.Collapsible.init(elems, undefined);
    });
    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.modal');
        var instances = M.Modal.init(elems, undefined);
        for (var e = 0; e < elems.legth; e++) {
            var instance = M.Modal.getInstance(elems[e]);
            instance.open();
        }
    });
    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.autocomplete');
        var instances = M.Autocomplete.init(elems, {
            data: {
                "Temple University": "https://pbs.twimg.com/profile_images/999732458470883328/Z7Q58gaZ_400x400.jpg",
                "Independence Hall": 'https://image.shutterstock.com/image-vector/liberty-bell-symbol-260nw-354893993.jpg',
                "Citizens Bank Park": 'https://upload.wikimedia.org/wikipedia/en/thumb/8/84/Philadelphia_Phillies.svg/1200px-Philadelphia_Phillies.svg.png',
                "Philadelphia Zoo": "https://i.pinimg.com/236x/f3/26/fb/f326fb350cf94a471feeb39fa34eb29f--lion-clipart-vector-clipart.jpg",
                "Philadelphia City Hall": "https://images.mentalfloss.com/sites/default/files/styles/mf_image_16x9/public/istock_67318445_small.jpg?itok=6zE9JHT_&resize=1100x1100",
                "Thomas Jefferson University": "https://www.underconsideration.com/brandnew/archives/jefferson_university_2017_monogram.png"
            }
        });
    });
</script>

</html>